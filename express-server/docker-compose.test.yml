# ============================================
# Enterprise Workflow Management System
# Docker Compose - Testing Environment
# Usage: docker-compose -f docker-compose.test.yml up -d
# ============================================

version: '3.9'

services:
  # Test database
  postgres-test:
    image: postgres:16-alpine
    container_name: workflow-postgres-test
    environment:
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
      POSTGRES_MULTIPLE_DATABASES: auth_db_test,user_db_test,permission_db_test,workflow_def_db_test,workflow_inst_db_test,task_db_test,approval_db_test,document_db_test,audit_db_test,notification_db_test,reporting_db_test
    volumes:
      - ./infrastructure/docker/postgres/init-databases.sh:/docker-entrypoint-initdb.d/init-databases.sh
    ports:
      - "5433:5432"
    tmpfs:
      - /var/lib/postgresql/data
    networks:
      - workflow-test-network

  # Test Redis
  redis-test:
    image: redis:7-alpine
    container_name: workflow-redis-test
    command: redis-server
    ports:
      - "6380:6379"
    tmpfs:
      - /data
    networks:
      - workflow-test-network

  # Test Kafka (using Redpanda for faster startup)
  redpanda-test:
    image: docker.redpanda.com/redpandadata/redpanda:v23.3.2
    container_name: workflow-redpanda-test
    command:
      - redpanda
      - start
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr internal://redpanda-test:9092,external://localhost:19092
      - --mode dev-container
      - --smp 1
    ports:
      - "19092:19092"
    tmpfs:
      - /var/lib/redpanda/data
    networks:
      - workflow-test-network

networks:
  workflow-test-network:
    driver: bridge
